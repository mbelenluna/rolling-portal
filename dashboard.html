<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crowdsourcing Portal — New Request | Rolling Translations</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <link rel="icon" href="data:,">
</head>
<body>

  <div class="ribbon">
    Crowdsourced Translation — separate, opt-in service for <b>non-regulated, low-risk content</b>.
    <a href="/professional" class="link">Need medical/legal? Professional Services →</a>
  </div>

  <div class="container">
    <img src="images/logo.png" alt="Rolling Translations Logo" class="logo" />
    <h1 class="title">Submit a Crowdsourced Translation</h1>
    <p class="subtitle">
      Upload your file, get an instant quote, and pay securely. <b>Not for medical, legal, or regulated content.</b>
    </p>

    <form id="projectRequestForm" class="card">
      <div class="grid">
        <div>
          <label for="sourceLang">Source Language (*)</label>
          <select id="sourceLang" required>
            <option value="">-- Select --</option>
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="pt">Portuguese</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="it">Italian</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
            <option value="zh">Chinese</option>
          </select>
        </div>
        <div>
          <label for="targetLang">Target Language (*)</label>
          <select id="targetLang" required>
            <option value="">-- Select --</option>
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="pt">Portuguese</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="it">Italian</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
            <option value="zh">Chinese</option>
          </select>
        </div>
      </div>

      <label for="file">Upload File (*)</label>
      <input type="file" id="file" required />

      <label for="notes">Notes</label>
      <textarea id="notes" rows="3" placeholder="Context, audience, tone, glossary links..."></textarea>

      <label class="checkbox">
        <input type="checkbox" id="nonRegulated" required />
        I confirm this content is not medical, legal, or otherwise regulated.
      </label>

      <div class="quote card soft">
        <h3>Instant Quote (beta)</h3>
        <p class="muted">We’ll auto-count when possible (TXT/SRT). Otherwise, enter your estimated words.</p>

        <div class="grid">
          <div>
            <label for="estWords">Estimated words</label>
            <input type="number" id="estWords" min="1" step="1" placeholder="e.g., 12000" />
          </div>
          <div>
            <label for="tier">Applied rate</label>
            <input type="text" id="tier" disabled placeholder="$—/word" />
          </div>
          <div>
            <label for="total">Estimated total</label>
            <input type="text" id="total" disabled placeholder="$0.00" />
          </div>
        </div>
        <button type="button" id="calcBtn" class="btn">Calculate</button>
      </div>

      <div class="actions">
        <button type="submit" class="btn primary">Submit & Pay</button>
        <button type="button" id="logoutBtn" class="btn">Log out</button>
      </div>
      <p id="confirmationMsg" class="success" style="display:none;">✅ Request submitted! Redirecting to payment…</p>
    </form>
  </div>

  <iframe name="hiddenFrame" style="display:none;"></iframe>
  <form id="spreadsheetForm" method="POST" target="hiddenFrame" style="display:none;"
    action="https://script.google.com/macros/s/AKfycbxbU9QqHS1oyYMBZz4kdNr1YYNHAlUZLIw-NWum8pjcZ8xckfHQgm6P1Qm6pa3oEzdCKQ/exec">
    <input name="fullname" id="fullnameField" />
    <input name="email" id="emailField" />
    <input name="phonenumber" id="phoneField" />
    <input name="sourceLang" id="sourceLangField" />
    <input name="targetLang" id="targetLangField" />
    <input name="notes" id="notesField" />
    <input name="fileName" id="fileNameField" />
  </form>

  <script type="module">
    // ===== Firebase CDN imports =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
    import { getFirestore, addDoc, collection, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-storage.js";
    // const analytics = getAnalytics(app);

    // ===== Firebase config =====
    const firebaseConfig = {
      apiKey: "AIzaSyCRrDn3p9alXlLjZN7SoBkJSodcSk2uZs8",
      authDomain: "rolling-crowdsourcing.firebaseapp.com",
      projectId: "rolling-crowdsourcing",
      storageBucket: "rolling-crowdsourcing.firebasestorage.app",
      messagingSenderId: "831997390366",
      appId: "1:831997390366:web:a86f5223fa22cc250b480f",
      measurementId: "G-77E7560XRX"
    };

    // ===== Init Firebase =====
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // EmailJS
    emailjs.init("NXdzFSlIax5PRevuB");

    // ===== Auth guard =====
    let clientFullName = "";
    let clientOrg = "";
    let clientEmail = "";

    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = "index.html"; return; }
      clientEmail = user.email || "";

      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      if (snap.exists()) {
        const u = snap.data();
        clientFullName = u.fullName || "";
        clientOrg = u.org || "";
      }
    });

    // ===== Logout =====
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        signOut(auth).then(() => (window.location.href = "index.html"));
      });
    }

    // ===== Instant Quote (beta) =====
    const estWordsEl = document.getElementById("estWords");
    const tierEl = document.getElementById("tier");
    const totalEl = document.getElementById("total");
    const calcBtn = document.getElementById("calcBtn");
    const fileInput = document.getElementById("file");
    const MIN_TOTAL_USD = 1.00;

    function rateForWords(w) {
      if (w >= 1000000) return 0.04;
      if (w >= 500000) return 0.05;
      if (w >= 300000) return 0.055;
      if (w >= 100000) return 0.06;
      if (w >= 50000) return 0.07;
      if (w >= 10000) return 0.08;
      return 0.10;
    }
    function formatUSD(n) {
      return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(n);
    }

    function computeQuote(w) {
      const rate = rateForWords(w || 0);
      const raw = (w || 0) * rate;
      const total = Math.max(raw, MIN_TOTAL_USD);
      const appliedMinimum = (w || 0) > 0 && raw < MIN_TOTAL_USD;
      return { rate, total, appliedMinimum };
    }

    function recalc() {
      const w = parseInt(estWordsEl?.value || "0", 10);
      if (!w || w <= 0) { tierEl.value = ""; totalEl.value = ""; return; }
      const { rate, total, appliedMinimum } = computeQuote(w);
      tierEl.value = `$${rate.toFixed(2)}/word`;
      totalEl.value = formatUSD(total) + (appliedMinimum ? " (min)" : "");
    }
    calcBtn?.addEventListener("click", recalc);
    estWordsEl?.addEventListener("input", recalc);

    // ===== Estado del upload para no duplicar =====
    let uploaded = null; // { gsPath, safeName, downloadURL }

    // Subir + cotizar automáticamente al elegir archivo
    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      try {
        const user = auth.currentUser;
        if (!user) { alert("Session expired. Please sign in again."); return; }

        // 1) Subir a Storage
        const safeName = `${Date.now()}_${file.name.replace(/[^\w\-\.]+/g, "_")}`;
        const fileRef = ref(storage, `crowd/uploads/${user.uid}/${safeName}`);
        await uploadBytes(fileRef, file, { contentType: file.type || "application/octet-stream" });

        // (Opcional) URL pública
        let downloadURL = null;
        try { downloadURL = await getDownloadURL(fileRef); } catch { downloadURL = null; }

        const gsPath = `crowd/uploads/${user.uid}/${safeName}`;
        uploaded = { gsPath, safeName, downloadURL };

        // 2) Llamar a la función HTTP para contar palabras
        const quoteResp = await fetch("https://us-central1-rolling-crowdsourcing.cloudfunctions.net/getQuoteForFile", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ gsPath, uid: user.uid })
        });
        if (!quoteResp.ok) throw new Error(`HTTP ${quoteResp.status}`);
        const q = await quoteResp.json();

        if (q.scanned) {
          estWordsEl.value = "";
          tierEl.value = "";
          totalEl.value = "";
          alert("We detected a scanned PDF. Please provide an estimated word count or upload a text-based file (DOCX/TXT/PDF con texto).");
          return;
        }

        const words = Number(q.words || 0);
        const rate  = Number(q.rate ?? rateForWords(words));
        const baseTotal = Number(q.total ?? (words * rate));
        const minAdjustedTotal = Math.max(baseTotal, MIN_TOTAL_USD); // $1 min

        estWordsEl.value = words > 0 ? String(words) : "";
        tierEl.value = `$${rate.toFixed(2)}/word`;
        totalEl.value = formatUSD(minAdjustedTotal) + ((words > 0 && words * rate < MIN_TOTAL_USD) ? " (min)" : "");

      } catch (err) {
        console.error(err);
        alert("Could not auto-count words. You can still enter an estimate manually.");
        uploaded = null; // reset si falla
      }
    });

    // ===== Submit & Pay flow =====
    const form = document.getElementById("projectRequestForm");
    const confirmationMsg = document.getElementById("confirmationMsg");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nonReg = document.getElementById("nonRegulated");
      if (!nonReg?.checked) {
        alert("Please confirm this is non-regulated content.");
        return;
      }

      const sourceLang = document.getElementById("sourceLang").value;
      const targetLang = document.getElementById("targetLang").value;
      const notes = document.getElementById("notes").value;
      const user = auth.currentUser;
      if (!user) { alert("Session expired. Please sign in again."); return; }

      // UI refs
      const estWordsEl = document.getElementById("estWords");
      const tierEl = document.getElementById("tier");
      const totalEl = document.getElementById("total");

      let fileName = null;
      let filePath = null;
      let downloadURL = null;

      // Reutilizar upload previo si existe
      if (uploaded?.gsPath) {
        fileName = uploaded.safeName;
        filePath = uploaded.gsPath;
        downloadURL = uploaded.downloadURL || null;
      } else {
        // Fallback: subir ahora
        const file = fileInput.files[0];
        if (!file) { alert("Please select a file."); return; }
        const safeName = `${Date.now()}_${file.name.replace(/[^\w\-\.]+/g, "_")}`;
        const fileRef = ref(storage, `crowd/uploads/${user.uid}/${safeName}`);
        await uploadBytes(fileRef, file, { contentType: file.type || "application/octet-stream" });
        try { downloadURL = await getDownloadURL(fileRef); } catch { downloadURL = null; }
        fileName = file.name;
        filePath = `crowd/uploads/${user.uid}/${safeName}`;
      }

      // === 1) Llamar a la función HTTP para cotizar ===
      let wordsFromFn = null, rateFromFn = null, totalFromFn = null, scanned = false;
      try {
        const quoteResp = await fetch("https://us-central1-rolling-crowdsourcing.cloudfunctions.net/getQuoteForFile", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ gsPath: filePath, uid: user.uid })
        });
        if (!quoteResp.ok) throw new Error(`HTTP ${quoteResp.status}`);
        const q = await quoteResp.json();

        wordsFromFn = Number(q.words ?? 0);
        rateFromFn  = q.rate  != null ? Number(q.rate)  : null;
        totalFromFn = q.total != null ? Number(q.total) : null;
        scanned = Boolean(q.scanned);

        // Aplicar mínimo si vino total
        if (totalFromFn != null) {
          totalFromFn = Math.max(Number(totalFromFn), MIN_TOTAL_USD);
        }

        if (scanned) {
          alert("We detected a scanned PDF. Please provide an estimated word count or upload a text-based file.");
        }
        if (wordsFromFn > 0) estWordsEl.value = String(wordsFromFn);

      } catch (err) {
        console.warn("Quote function error:", err?.message || err);
        // El usuario puede ingresar words manualmente
      }

      // === 2) Calcular valores finales (siempre en un solo lugar) ===
      const estWordsManual = parseInt(estWordsEl?.value || "0", 10) || 0;
      const estWordsFinal  = (wordsFromFn && wordsFromFn > 0) ? wordsFromFn : estWordsManual;

      const rateFinal  = (rateFromFn != null) ? rateFromFn : rateForWords(estWordsFinal || 0);
      const totalFinal = (totalFromFn != null)
        ? totalFromFn
        : Math.max(((estWordsFinal || 0) * rateFinal), MIN_TOTAL_USD);

      // Reflejar en UI (por si no apretó "Calculate")
      tierEl.value  = rateFinal ? `$${rateFinal.toFixed(2)}/word` : tierEl.value;
      const showMinTag = ((estWordsFinal || 0) > 0) && ((estWordsFinal || 0) * rateFinal < MIN_TOTAL_USD);
      totalEl.value = formatUSD(totalFinal) + (showMinTag ? " (min)" : "");

      try {
        // === 3) Guardar en Firestore ===
        const payload = {
          email: clientEmail,
          fullName: clientFullName,
          org: clientOrg,
          sourceLang,
          targetLang,
          notes,
          fileName,
          filePath,
          estWords: estWordsFinal,
          rate: rateFinal,
          estimatedTotal: totalFinal,
          nonRegulated: true,
          status: "pending_payment",
          createdAt: serverTimestamp()
        };
        if (downloadURL) payload.downloadURL = downloadURL;
        if (scanned) payload.scanDetected = true;

        const reqRef = await addDoc(collection(db, "crowdRequests"), payload);

        // === 4) EmailJS (no bloqueante) ===
        try {
          await emailjs.send("service_mugdac3", "template_a6ade8h", {
            sourceLang, targetLang, notes,
            file: fileName,
            email: clientEmail || "info@rolling-translations.com",
            clientFullName, clientOrg, requestId: reqRef.id
          });
        } catch (e) { console.warn("EmailJS:", e?.message || e); }

        // === 5) Apps Script (opcional) ===
        try {
          document.getElementById("fullnameField").value = clientFullName;
          document.getElementById("emailField").value = clientEmail || "info@rolling-translations.com";
          document.getElementById("phoneField").value = "";
          document.getElementById("sourceLangField").value = sourceLang;
          document.getElementById("targetLangField").value = targetLang;
          document.getElementById("notesField").value = notes;
          document.getElementById("fileNameField").value = fileName;
          document.getElementById("spreadsheetForm").submit();
        } catch (e) { console.warn("Apps Script:", e?.message || e); }

        // === 6) UI ===
        confirmationMsg.style.display = "block";

        // === 7) TODO: Stripe Checkout ===
        // const resp = await fetch("/api/checkout", {
        //   method: "POST",
        //   headers: { "Content-Type": "application/json" },
        //   body: JSON.stringify({ requestId: reqRef.id, estWords: estWordsFinal })
        // });
        // const { url } = await resp.json();
        // window.location.href = url;

        alert("Payment step placeholder: connect Stripe Checkout and redirect here.");
        form.reset();
        uploaded = null;
        tierEl.value = "";
        totalEl.value = "";
        estWordsEl.value = "";

      } catch (error) {
        console.error(error);
        alert("⚠️ Error: " + (error?.message || error));
      }
    });
  </script>
</body>
</html>
