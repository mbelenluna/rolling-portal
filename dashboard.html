<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crowdsourcing Portal — New Request | Rolling Translations</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>
  
  <div class="ribbon">
    Crowdsourced Translation — separate, opt‑in service for <b>non‑regulated, low‑risk content</b>.
    <a href="/professional" class="link">Need medical/legal? Professional Services →</a>
  </div>

  <div class="container">
    <img src="images/logo.png" alt="Rolling Translations Logo" class="logo" />
    <h1 class="title">Submit a Crowdsourced Translation</h1>
    <p class="subtitle">
      Upload your file, get an instant quote, and pay securely. <b>Not for medical, legal, or regulated content.</b>
    </p>

    <form id="projectRequestForm" class="card">
      <div class="grid">
        <div>
          <label for="sourceLang">Source Language (*)</label>
          <select id="sourceLang" required>
            <option value="">-- Select --</option>
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="pt">Portuguese</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="it">Italian</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
            <option value="zh">Chinese</option>
          </select>
        </div>
        <div>
          <label for="targetLang">Target Language (*)</label>
          <select id="targetLang" required>
            <option value="">-- Select --</option>
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="pt">Portuguese</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="it">Italian</option>
            <option value="ja">Japanese</option>
            <option value="ko">Korean</option>
            <option value="zh">Chinese</option>
          </select>
        </div>
      </div>

      <label for="file">Upload File (*)</label>
      <input type="file" id="file" required />

      <label for="notes">Notes</label>
      <textarea id="notes" rows="3" placeholder="Context, audience, tone, glossary links..."></textarea>

      <label class="checkbox">
        <input type="checkbox" id="nonRegulated" required />
        I confirm this content is <b>not medical, legal, governmental, or otherwise regulated</b>.
      </label>

      <div class="quote card soft">
        <h3>Instant Quote (beta)</h3>
        <p class="muted">We’ll auto‑count when possible (TXT/SRT). Otherwise, enter your estimated words.</p>

        <div class="grid">
          <div>
            <label for="estWords">Estimated words</label>
            <input type="number" id="estWords" min="1" step="1" placeholder="e.g., 12000" />
          </div>
          <div>
            <label for="tier">Applied rate</label>
            <input type="text" id="tier" disabled placeholder="$—/word" />
          </div>
          <div>
            <label for="total">Estimated total</label>
            <input type="text" id="total" disabled placeholder="$0.00" />
          </div>
        </div>
        <button type="button" id="calcBtn" class="btn">Calculate</button>
      </div>

      <div class="actions">
        <button type="submit" class="btn primary">Submit & Pay</button>
        <button type="button" id="logoutBtn" class="btn">Log out</button>
      </div>
      <p id="confirmationMsg" class="success" style="display:none;">✅ Request submitted! Redirecting to payment…</p>
    </form>
  </div>

  <iframe name="hiddenFrame" style="display:none;"></iframe>
  <form id="spreadsheetForm" method="POST" target="hiddenFrame" style="display:none;"
    action="https://script.google.com/macros/s/AKfycbxbU9QqHS1oyYMBZz4kdNr1YYNHAlUZLIw-NWum8pjcZ8xckfHQgm6P1Qm6pa3oEzdCKQ/exec">
    <input name="fullname" id="fullnameField" />
    <input name="email" id="emailField" />
    <input name="phonenumber" id="phoneField" />
    <input name="sourceLang" id="sourceLangField" />
    <input name="targetLang" id="targetLangField" />
    <input name="notes" id="notesField" />
    <input name="fileName" id="fileNameField" />
  </form>

  <script type="module">
  // ===== Firebase CDN imports =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
  import { getFirestore, addDoc, collection, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-storage.js";
  // Optional analytics:
  // import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-analytics.js";

  // ===== Firebase config (your new project) =====
  const firebaseConfig = {
    apiKey: "AIzaSyCRrDn3p9alXlLjZN7SoBkJSodcSk2uZs8",
    authDomain: "rolling-crowdsourcing.firebaseapp.com",
    projectId: "rolling-crowdsourcing",
    storageBucket: "rolling-crowdsourcing.appspot.com",
    messagingSenderId: "831997390366",
    appId: "1:831997390366:web:a86f5223fa22cc250b480f",
    measurementId: "G-77E7560XRX"
  };

  // ===== Init Firebase =====
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);
  // const analytics = getAnalytics(app); // if you enabled Analytics


  emailjs.init("NXdzFSlIax5PRevuB");

  // ===== Auth guard =====
  let clientFullName = "";
  let clientOrg = "";
  let clientEmail = "";

  onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    clientEmail = user.email || "";

    // Load profile
    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);
    if (snap.exists()) {
      const u = snap.data();
      clientFullName = u.fullName || "";
      clientOrg = u.org || "";
    }
  });

  // ===== Logout =====
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => (window.location.href = "index.html"));
    });
  }

  // ===== Instant Quote (beta) =====
  const estWordsEl = document.getElementById("estWords");
  const tierEl = document.getElementById("tier");
  const totalEl = document.getElementById("total");
  const calcBtn = document.getElementById("calcBtn");

  function rateForWords(w) {
    if (w >= 300000) return 0.05; // enterprise floor example
    if (w >= 100000) return 0.06;
    if (w >= 10000)  return 0.07;
    if (w >= 1000)   return 0.09;
    return 0.10;
  }
  function formatUSD(n) {
    return new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(n);
  }
  function recalc() {
    const w = parseInt(estWordsEl?.value || "0", 10);
    if (!w || w <= 0) { tierEl.value = ""; totalEl.value = ""; return; }
    const rate = rateForWords(w);
    tierEl.value = `$${rate.toFixed(2)}/word`;
    totalEl.value = formatUSD(w * rate);
  }
  calcBtn?.addEventListener("click", recalc);
  estWordsEl?.addEventListener("input", recalc);

  // ===== Submit & Pay flow =====
  const form = document.getElementById("projectRequestForm");
  const confirmationMsg = document.getElementById("confirmationMsg");

  // Helper for multi-selects if you use them later
  const getSelectedValues = (selectEl) =>
    Array.from(selectEl.selectedOptions || []).map(o => o.value);

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Validate non-regulated checkbox
    const nonReg = document.getElementById("nonRegulated");
    if (!nonReg?.checked) {
      alert("Please confirm this is non-regulated content.");
      return;
    }

    // Gather fields
    const sourceLang = document.getElementById("sourceLang").value;
    const targetLang = document.getElementById("targetLang").value;
    const notes = document.getElementById("notes").value;
    const file = document.getElementById("file").files[0];
    const estWords = parseInt(estWordsEl?.value || "0", 10) || null;

    if (!file) { alert("Please select a file."); return; }

    try {
      // Current user (for path)
      const user = auth.currentUser;
      if (!user) { alert("Session expired. Please sign in again."); return; }

      // 1) Upload file to Storage
      const safeName = `${Date.now()}_${file.name.replace(/[^\w\-\.]+/g, "_")}`;
      const fileRef = ref(storage, `crowd/uploads/${user.uid}/${safeName}`);
      await uploadBytes(fileRef, file);

      // (Optional) URL for internal use
      const downloadURL = await getDownloadURL(fileRef);

      // 2) Create request in Firestore
      const reqRef = await addDoc(collection(db, "crowdRequests"), {
        email: clientEmail,
        fullName: clientFullName,
        org: clientOrg,
        sourceLang,
        targetLang,
        notes,
        fileName: file.name,
        filePath: `crowd/uploads/${user.uid}/${safeName}`,
        downloadURL,
        estWords,
        nonRegulated: true,
        status: "pending_payment",
        createdAt: serverTimestamp()
      });

      // 3) EmailJS notify (optional)
      try {
        await emailjs.send(
          "service_mugdac3",
          "template_a6ade8h",
          {
            sourceLang,
            targetLang,
            notes,
            file: file.name,
            email: clientEmail || "info@rolling-translations.com",
            clientFullName,
            clientOrg,
            requestId: reqRef.id
          }
        );
        console.log("✅ Email sent via EmailJS");
      } catch (err) {
        console.warn("EmailJS error (non-blocking):", err?.message || err);
      }

      // 4) Apps Script row (optional, as you had it)
      try {
        document.getElementById("fullnameField").value = clientFullName;
        document.getElementById("emailField").value   = clientEmail || "info@rolling-translations.com";
        document.getElementById("phoneField").value   = "";
        document.getElementById("sourceLangField").value = sourceLang;
        document.getElementById("targetLangField").value = targetLang;
        document.getElementById("notesField").value   = notes;
        document.getElementById("fileNameField").value= file.name;
        document.getElementById("spreadsheetForm").submit();
      } catch (err) {
        console.warn("Apps Script submit error (non-blocking):", err?.message || err);
      }

      // 5) UI feedback
      form.reset();
      recalc();
      confirmationMsg.style.display = "block";

      // 6) TODO: Redirect to Stripe Checkout (replace with your backend endpoint)
      // const resp = await fetch("/api/checkout", {
      //   method: "POST",
      //   headers: { "Content-Type": "application/json" },
      //   body: JSON.stringify({ requestId: reqRef.id, estWords })
      // });
      // const { url } = await resp.json();
      // window.location.href = url;

      alert("Payment step placeholder: connect Stripe Checkout and redirect here.");

    } catch (error) {
      alert("⚠️ Error: " + (error?.message || error));
      console.error(error);
    }
  });
</script>

</body>
</html>
